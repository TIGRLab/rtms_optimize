#!/bin/bash

#Arguments
#	subject			Subject name
#	inp_sphere		Input sphere
#	ref_sphere		Reference sphere
#	hemi			Hemisphere to work on (L/R)
#	metric			Metric file
#	out			Output file 

#Description
#Convenience script to convert freesurfer surfaces to connectome workbench format

#	House-cleaning functions

close(){
	STATUS=$?
	if [ "$STATUS" == 0 ]; then
		echo "simfs_to_gifti finished, Exiting..."
	else
		echo "simfs_to_gifti failed!"
		echo "Exiting!"
		exit 1
	fi

}

stdprint(){
	echo "#######################"
	echo "$1"
	echo "#######################"
}

checkvar(){

	if  [ -z $1 ]; then

		echo "$2 doesn't exist!"
		exit 1

	fi

}

trap close EXIT

#	STAGE 0: Check inputs
subject=$1
inp_sphere=$2
ref_sphere=$3
hemi=$4
parcel=$5
out=$6

checkvar "$subject" subject
checkvar "$inp_sphere" inp_sphere
checkvar "$ref_sphere" ref_sphere
checkvar "$hemi" hemi
checkvar "$parcel" parcel
checkvar "$out" out
checkvar "$SUBJECTS_DIR" SUBJECTS_DIR
checkvar "$RTMSBIN" RTMSBIN

atlasdir=/projects/jjeyachandra/rtms_optimize/resources
hemi=${hemi^^}

declare -A struct_map
struct_map=( ['L']='CORTEX_LEFT' ['R']='CORTEX_RIGHT')
structure=${struct_map[$hemi]}

#	STAGE 1: Resample parcellation file
sphere_32k="$atlasdir/$hemi.sphere.32k_fs_LR.surf.gii"
resampled="$outdir/fs_$subject.$hemi.mshbm_parcels.label.gii"

wb_command -label-resample "$parcel" "$sphere_32k" "$sphere" BARYCENTRIC "$resampled"
wb_command -set-structure "$resampled" "$structure"
