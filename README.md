# rtms_optimize
Repo for building rTMS coil optimization method
*** 
# Mesh Correspondence between Surfaces 
***
## Construction of simNIBS optimized mesh geometry and comparison to fs_LR_32k

#### Objective:
Establish a correspondence between the individualized functional network parcellation embedded in **fs_LR_32k** space and the optimized mesh generated by the simNIBS re-meshing algorithm.  

#### Requirements:
Since we're modelling the grey matter and the volumetric mesh contains representations for different tissue types, we don't just want a surface projection but a **surface to discrete volume projection**, since this will better model the regions that we want to stimulate since it will have finite volume. 

#### Progress Notes:

## Cross-registration of simNIBS -->fs_LR_32k

#### Components to work with:
1. simNIBS surface sphere with sulcal depth topology
2. fs_LR_32k standardized surface. 

Perform registration to MNINonLinear/Native using MSM. Then should be able to re-sample the individualizd parcellations over, or alternatively should try to re-sample the sulcal surface onto fs_LR_32k. 

#### Steps to implement
- [x] Convert freesurfer spherical surface into GIFTI format
- [x] Convert freesurfer sulcal depth map to GIFTI metric map (.shape.gii)
- [x] Generate sphere.reg from Native to fsaverage
- [x] Generate registration sphere from Native --> fsaverage --> fs_LR_164k using -surface-sphere-project-unproject
- [x] Make MSMSulc source sphere
  - [x] Assign structure
  - [x] Convert height --> depth map
  - [x] Apply alignment transformation of native to fsaverage_LR_164k
  - [x] Apply affine registration
  - [x] Set radius at 100
- [x] Perform MSMSulc registration between mesh-generated sphere --> 164k MNINonLinear Native (or perhaps a lower resolution fs_LR_32k)
- [ ] Resample individualized parcellation from MNINonLinear/fs_LR_32k $\implies$ MNINonLinear/Native_164k 


Since coordinate will approximately (urghh) match the tetrahedral vertices can match exactly I think...

## Bayesian Optimization of rTMS Field Distribution

We're using a Bayesian Optimization approach here since evaluating the objective function (simulating the field distribution for a given position of the coil) is expensive. In addition we don't have direct access to the gradient information so a sampling approach is called for. 

Optimization will therefore be performed using Bayesian Optimization with Gaussian Process priors. We can justify the use of this since we expect changing electric field distributions over the target area to be a smooth function with many local maxima. 

Toolbox to be used: [fmfn/BayesianOptimization](https://github.com/fmfn/BayesianOptimization).

